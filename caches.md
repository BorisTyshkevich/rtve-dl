# Cache and Reset Internals

This document describes all cache layers used by `rtve_dl`, reset semantics, and how resume works for Codex chunk translation.

## Scope

- Episode processing cache: `tmp/<slug>/...`
- Final outputs: `data/<slug>/...`
- Selector-scoped reset: `--reset-layer ...` affects only episodes selected by the current selector (`T7`, `T7S9`, etc.)
- Slug-scoped reset: `catalog` layer

## Directory Layout

- `data/<slug>/`
  - final `.mkv` per episode
  - `index.html`
  - generated `.m3u` helper links (from HTML JS)
- `tmp/<slug>/`
  - downloaded/transcoded sources (`.mp4`, `.vtt`, `.srt`)
  - Codex chunk inputs/outputs/logs (`.jsonl`, `.log`)
  - ASR artifacts/logs
  - catalog cache (`catalog_*.json`)
  - auto subtitle delay cache (`subtitle_delay.auto.json`)
  - index metadata translation cache (`index_meta_ru.json`)

## Episode Cache Objects

For an episode base name `SxxExx_<title>` and `asset_id`:

- Video
  - `tmp/<slug>/<base>.mp4`
  - `tmp/<slug>/<base>.mp4.partial.mp4`

- Source subtitles
  - `tmp/<slug>/<asset_id>.es.vtt`
  - `tmp/<slug>/<asset_id>.en.vtt`

- Built subtitles
  - `tmp/<slug>/<base>.spa.srt`
  - `tmp/<slug>/<base>.eng.srt`
  - `tmp/<slug>/<base>.rus.srt`
  - `tmp/<slug>/<base>.spa_rus.srt`

- Codex EN chunk cache (ES->EN fallback)
  - `tmp/<slug>/<base>.en*.jsonl`
  - `tmp/<slug>/<base>.en*.out.*.jsonl`
  - `tmp/<slug>/<base>.en*.log`

- Codex RU full chunk cache
  - `tmp/<slug>/<base>.ru*.jsonl`
  - `tmp/<slug>/<base>.ru*.out.*.jsonl`
  - `tmp/<slug>/<base>.ru*.log`
  - Excludes refs prefix in logic where needed.

- Codex RU refs chunk cache
  - `tmp/<slug>/<base>.ru_ref*.jsonl`
  - `tmp/<slug>/<base>.ru_ref*.out.*.jsonl`
  - `tmp/<slug>/<base>.ru_ref*.log`

- ASR artifacts/logs (when ASR fallback is used)
  - `tmp/<slug>/<base>.asr*` (if generated by backend)

- Final output
  - `data/<slug>/<base>.mkv`
  - `data/<slug>/<base>.mkv.partial.mkv`

## Slug Cache Objects

- `tmp/<slug>/catalog_<hash>.json`
- `tmp/<slug>/subtitle_delay.auto.json`
- `tmp/<slug>/index_meta_ru.json`

## Cache Hit Policy

- If `data/<slug>/<base>.mkv` exists, episode is skipped.
- If MKV is missing but local mux inputs are present and valid (`mp4 + required srt tracks`), resolver/network is skipped and only mux runs.
- `.partial.mp4` and `.partial.mkv` are used for safe writes, then atomically renamed.
- Empty cache files are removed before reuse checks.

## Public Reset Layers

`--reset-layer` supports only:

- `subs-es`
- `subs-en`
- `subs-ru`
- `subs-refs`
- `video`
- `mkv`
- `catalog`

Unknown layer values fail fast.

## Layer Dependency Expansion

Reset expands internally to dependent layers:

- `video` => `video + subs-es + subs-en + subs-ru + subs-refs + mkv`
- `subs-es` => `subs-es + subs-en + subs-ru + subs-refs + mkv`
- `subs-en` => `subs-en + mkv`
- `subs-ru` => `subs-ru + mkv`
- `subs-refs` => `subs-refs + mkv`
- `mkv` => `mkv`
- `catalog` => `catalog`

## What Each Reset Layer Deletes

Episode layers:

- `mkv`
  - `data/<slug>/<base>.mkv`
  - `data/<slug>/<base>.mkv.partial.mkv`

- `video`
  - `tmp/<slug>/<base>.mp4`
  - `tmp/<slug>/<base>.mp4.partial.mp4`

- `subs-es`
  - `tmp/<slug>/<base>.spa.srt`
  - `tmp/<slug>/<asset_id>.es.vtt`
  - EN/RU/refs Codex chunk caches (`<base>.en*`, `<base>.ru*`, `<base>.ru_ref*`)

- `subs-en`
  - `tmp/<slug>/<base>.eng.srt`
  - `tmp/<slug>/<asset_id>.en.vtt`
  - EN Codex chunk caches (`<base>.en*`)

- `subs-ru`
  - `tmp/<slug>/<base>.rus.srt`
  - RU full Codex chunk caches (`<base>.ru*`, excluding `<base>.ru_ref*`)

- `subs-refs`
  - `tmp/<slug>/<base>.spa_rus.srt`
  - RU refs Codex chunk caches (`<base>.ru_ref*`)

Slug layer:

- `catalog`
  - `tmp/<slug>/catalog_*.json`

## Critical Resume Rule (Codex JSONL)

There are two distinct behaviors:

1. Normal crash/restart (no reset)
- Existing chunk outputs are reused.
- Only missing chunks are sent to `codex exec`.
- This is the main resumability guarantee.

2. Explicit subtitle reset (`subs-en`, `subs-ru`, `subs-refs`, or cascading from `subs-es`/`video`)
- Matching SRT is deleted.
- Matching Codex chunk caches are also deleted intentionally.
- This forces clean retranslation for that layer.

## Selector Scope

- `T7S9` reset affects only S07E09 files.
- `T7` reset affects only episodes selected in season 7.
- `catalog` is slug-level and not episode-limited.

## Troubleshooting Patterns

- Rebuild MKV only:
  - `--reset-layer mkv`
- Recreate learning refs subtitles:
  - `--reset-layer subs-refs`
- Recreate full Russian subtitles:
  - `--reset-layer subs-ru`
- Recreate English fallback subtitles:
  - `--reset-layer subs-en`
- Full episode pipeline from new video source:
  - `--reset-layer video`
- Force RTVE catalog refresh:
  - `--reset-layer catalog`
