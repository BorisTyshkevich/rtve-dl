# Cache and Reset Internals

This document describes all cache layers used by `rtve_dl`, reset semantics, and how resume works for Codex chunk translation.

## Scope

- Episode processing cache: `tmp/<slug>/...`
- Final outputs: `data/<slug>/...`
- Selector-scoped reset: `--reset-layer ...` affects only episodes selected by the current selector (`T7`, `T7S9`, etc.)
- Reset timing: selector reset is executed once in preflight before episode processing starts.
- Slug-scoped reset: `catalog` layer

## Directory Layout

- `data/<slug>/`
  - final `.mkv` per episode
  - `index.html`
  - generated `.m3u` helper links (from HTML JS)
- `tmp/<slug>/`
  - downloaded/transcoded sources (`.mp4`, `.vtt`, `.srt`)
  - Codex chunk inputs/outputs/logs (`.jsonl`, `.tsv`, `.log`)
  - ASR artifacts/logs
  - catalog cache (`catalog_*.json`)
  - auto subtitle delay cache (`subtitle_delay.auto.json`)
  - index metadata translation cache (`index_meta_ru.json`)
  - run telemetry DB (`telemetry.sqlite`)
- `data/global_phrase_cache.json`
  - optional static global cache for repeated ES phrases (`ru_full`, `ru_refs`, `en_mt`)

## Episode Cache Objects

For an episode base name `SxxExx_<title>` and `asset_id`:

- Video
  - `tmp/<slug>/<base>.mp4`
  - `tmp/<slug>/<base>.mp4.partial.mp4`

- Source subtitles
  - `tmp/<slug>/<asset_id>.es.vtt`
  - `tmp/<slug>/<asset_id>.en.vtt`

- Built subtitles
  - `tmp/<slug>/<base>.spa.srt`
  - `tmp/<slug>/<base>.eng.srt`
  - `tmp/<slug>/<base>.rus.srt`
  - `tmp/<slug>/<base>.spa_rus.srt`
  - `tmp/<slug>/<base>.spa_rus_full.srt`

- Codex EN chunk cache (ES->EN fallback)
  - `tmp/<slug>/<base>.en*.jsonl`
  - `tmp/<slug>/<base>.en*.tsv`
  - `tmp/<slug>/<base>.en*.out.*.jsonl`
  - `tmp/<slug>/<base>.en*.log`

- Codex RU full chunk cache
  - `tmp/<slug>/<base>.ru*.jsonl`
  - `tmp/<slug>/<base>.ru*.tsv`
  - `tmp/<slug>/<base>.ru*.out.*.jsonl`
  - `tmp/<slug>/<base>.ru*.log`
  - Excludes refs prefix in logic where needed.

- Codex RU refs chunk cache
  - `tmp/<slug>/<base>.ru_ref*.jsonl`
  - `tmp/<slug>/<base>.ru_ref*.tsv`
  - `tmp/<slug>/<base>.ru_ref*.out.*.jsonl`
  - `tmp/<slug>/<base>.ru_ref*.log`

- ASR artifacts/logs (when ASR fallback is used)
  - `tmp/<slug>/<base>.asr*` (if generated by backend)

- Final output
  - `data/<slug>/<base>.mkv`
  - `data/<slug>/<base>.mkv.partial.mkv`

## Slug Cache Objects

- `tmp/<slug>/catalog_<hash>.json`
- `tmp/<slug>/subtitle_delay.auto.json`
- `tmp/<slug>/index_meta_ru.json`
- `tmp/<slug>/telemetry.sqlite`
  - schema defined in `sql/schema.sql`
  - aggregate queries in `sql/reports.sql`

## Cache Hit Policy

- If `data/<slug>/<base>.mkv` exists, episode is skipped.
- If MKV is missing but local mux inputs are present and valid (`mp4 + required srt tracks`), resolver/network is skipped and only mux runs.
- `.partial.mp4` and `.partial.mkv` are used for safe writes, then atomically renamed.
- Empty cache files are removed before reuse checks.

## Public Reset Layers

`--reset-layer` supports only:

- `subs-es`
- `subs-en`
- `subs-ru`
- `subs-refs`
- `video`
- `mkv`
- `catalog`

Unknown layer values fail fast.

## Layer Dependency Expansion

Reset expands internally to dependent layers:

- `video` => `video + subs-es + subs-en + subs-ru + subs-refs + mkv`
- `subs-es` => `subs-es + subs-en + subs-ru + subs-refs + mkv`
- `subs-en` => `subs-en + mkv`
- `subs-ru` => `subs-ru + mkv`
- `subs-refs` => `subs-refs + mkv`
- `mkv` => `mkv`
- `catalog` => `catalog`

## What Each Reset Layer Deletes

Episode layers:

- `mkv`
  - `data/<slug>/SxxExx_*.mkv` for selected episodes
  - `data/<slug>/SxxExx_*.mkv.partial.mkv` for selected episodes

- `video`
  - `tmp/<slug>/SxxExx_*.mp4` for selected episodes
  - `tmp/<slug>/SxxExx_*.mp4.partial.mp4` for selected episodes

- `subs-es`
  - `tmp/<slug>/SxxExx_*.spa.srt` for selected episodes
  - `tmp/<slug>/<asset_id>.es.vtt`
  - EN/RU/refs Codex chunk caches (`SxxExx_*.en*`, `SxxExx_*.ru*`, `SxxExx_*.ru_ref*`)

- `subs-en`
  - `tmp/<slug>/SxxExx_*.eng.srt` for selected episodes
  - `tmp/<slug>/<asset_id>.en.vtt`
  - EN Codex chunk caches (`SxxExx_*.en*`)

- `subs-ru`
  - `tmp/<slug>/SxxExx_*.rus.srt` for selected episodes
  - `tmp/<slug>/SxxExx_*.spa_rus_full.srt` for selected episodes
  - RU full Codex chunk caches (`SxxExx_*.ru*`, excluding `*.ru_ref*`)

- `subs-refs`
  - `tmp/<slug>/SxxExx_*.spa_rus.srt` for selected episodes
  - RU refs Codex chunk caches (`SxxExx_*.ru_ref*`)

Slug layer:

- `catalog`
  - `tmp/<slug>/catalog_*.json`

## Critical Resume Rule (Codex JSONL)

There are two distinct behaviors:

1. Normal crash/restart (no reset)
- Existing chunk outputs are reused.
- Only missing chunks are sent to `codex exec`.
- This is the main resumability guarantee.
- Codex I/O format:
  - internal durable cache: JSONL
  - LLM payload/response: TSV (smaller token footprint)

2. Explicit subtitle reset (`subs-en`, `subs-ru`, `subs-refs`, or cascading from `subs-es`/`video`)
- Matching SRT is deleted.
- Matching Codex chunk caches are also deleted intentionally.
- This forces clean retranslation for that layer.
- This reset happens in preflight for all selected episodes.

## Selector Scope

- `T7S9` reset affects only S07E09 files.
- `T7` reset affects only episodes selected in season 7.
- `catalog` is slug-level and not episode-limited.
- `data/global_phrase_cache.json` is not affected by reset layers.
- Recommended restart flow after crash in season reset:
  - first run with `--reset-layer ...`
  - restart without `--reset-layer` to continue from cache

## Troubleshooting Patterns

- Rebuild MKV only:
  - `--reset-layer mkv`
- Recreate learning refs subtitles:
  - `--reset-layer subs-refs`
- Recreate full Russian subtitles:
  - `--reset-layer subs-ru`
- Recreate English fallback subtitles:
  - `--reset-layer subs-en`
- Full episode pipeline from new video source:
  - `--reset-layer video`
- Force RTVE catalog refresh:
  - `--reset-layer catalog`
